<!doctype html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">

<head>
    <meta charset="UTF-8" />
    <title>UniLife íšŒì›ê°€ì…</title>
    <link href="https://fonts.googleapis.com/css2?family=Righteous&display=swap" rel="stylesheet" />
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .font-righteous {
            font-family: 'Righteous', cursive;
        }
    </style>

</head>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        const signupForm = document.getElementById("signupForm");
        const signupBtn = document.getElementById("signupBtn");
        const goToLogin = document.getElementById("goToLogin");

        goToLogin.addEventListener("click", function () {
            window.location.href = "/login";
        });

        // 1. ì•„ì´ë”” ì¤‘ë³µí™•ì¸
        document.getElementById("checkIdBtn").addEventListener("click", function () {
            const userId = document.getElementById("userId").value.trim();
            const resultDiv = document.getElementById("idCheckResult");

            if (userId === "") {
                resultDiv.innerText = "ì•„ì´ë””ë¥¼ ì…ë ¥í•˜ì„¸ìš”.";
                resultDiv.className = "text-sm text-red-500";
                signupBtn.disabled = true;
                return;
            }

            fetch(`/api/check-id?userId=${userId}`)
                .then(res => {
                    if (!res.ok) throw new Error("ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜");
                    return res.json();
                })
                .then(data => {
                    if (data.duplicate) {
                        resultDiv.innerText = "ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ì•„ì´ë””ì…ë‹ˆë‹¤.";
                        resultDiv.className = "text-sm text-red-500";
                        signupBtn.disabled = true;
                    } else {
                        resultDiv.innerText = "ì‚¬ìš© ê°€ëŠ¥í•œ ì•„ì´ë””ì…ë‹ˆë‹¤.";
                        resultDiv.className = "text-sm text-green-500";
                        signupBtn.disabled = false;
                    }
                })
                .catch(err => {
                    console.error("ID ì¤‘ë³µí™•ì¸ ì˜¤ë¥˜:", err);
                    alert("ID ì¤‘ë³µí™•ì¸ ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì„œë²„ ìƒíƒœ ë˜ëŠ” ë¡œê·¸ì¸ ì—¬ë¶€ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.");
                });
        });

        // 2. ì´ë©”ì¼ ì¸ì¦ì½”ë“œ ì „ì†¡
        document.getElementById("sendEmailBtn").addEventListener("click", function () {
            const email = document.getElementById("email").value.trim();
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

            if (email === "" || !emailRegex.test(email)) {
                alert("ì˜¬ë°”ë¥¸ ì´ë©”ì¼ ì£¼ì†Œë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
                return;
            }

            fetch(`/api/send-email?email=${email}`)
                .then(res => res.text())
                .then(() => alert("ì¸ì¦ì½”ë“œê°€ ì´ë©”ì¼ë¡œ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤."));
        });

        // 3. ì´ë©”ì¼ ì¸ì¦ í™•ì¸
        document.getElementById("verifyEmailBtn").addEventListener("click", function () {
            const email = document.getElementById("email").value.trim();
            const code = document.getElementById("authCode").value.trim();
            const resultDiv = document.getElementById("emailVerifyResult");

            if (email === "" || code === "") {
                resultDiv.innerText = "ì´ë©”ì¼ê³¼ ì¸ì¦ì½”ë“œë¥¼ ëª¨ë‘ ì…ë ¥í•˜ì„¸ìš”.";
                resultDiv.className = "text-sm text-red-500";
                return;
            }

            fetch(`/api/verify-email`, {
                method: "POST",
                headers: { "Content-Type": "application/x-www-form-urlencoded" },
                body: new URLSearchParams({ email: email, code: code })
            })
                .then(res => {
                    if (res.ok) {
                        resultDiv.innerText = "ì¸ì¦ë˜ì—ˆìŠµë‹ˆë‹¤.";
                        resultDiv.className = "text-sm text-green-500";
                        document.getElementById("emailVerified").value = "true";
                    } else {
                        resultDiv.innerText = "ì¸ì¦ ì‹¤íŒ¨";
                        resultDiv.className = "text-sm text-red-500";
                    }
                });
        });

        // 4. ì•„ì´ë”” ì…ë ¥ê°’ì´ ë°”ë€Œë©´ ë‹¤ì‹œ ì¤‘ë³µí™•ì¸ í•˜ë„ë¡
        document.getElementById("userId").addEventListener("input", function () {
            document.getElementById("idCheckResult").innerText = "";
            signupBtn.disabled = true;
        });

        // 5. í¼ ì œì¶œ ì‹œ ì´ë©”ì¼ ì¸ì¦ í™•ì¸
        signupForm.addEventListener("submit", function (event) {
            const emailVerified = document.getElementById("emailVerified").value;
            if (emailVerified !== "true") {
                alert("ì´ë©”ì¼ ì¸ì¦ì„ ì™„ë£Œí•´ì£¼ì„¸ìš”.");
                event.preventDefault(); // ğŸš« ì œì¶œ ë§‰ê¸°
            }
        });

        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.has('signupSuccess')) {
            alert("íšŒì›ê°€ì…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ë¡œê·¸ì¸ í•´ì£¼ì„¸ìš”.");
        } else if (urlParams.has('signupFail')) {
            alert("íšŒì›ê°€ì…ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
        } else if (urlParams.has('pwError')) {
            alert("ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
        } else if (urlParams.has('pwSuccess')) {
            alert("ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•©ë‹ˆë‹¤.");
        } else if (urlParams.has('idError')) {
            alert("ì•„ì´ë””ê°€ ì¤‘ë³µë˜ì—ˆìŠµë‹ˆë‹¤.");
        } else if (urlParams.has('emailError')) {
            alert("ì´ë©”ì¼ ì¸ì¦ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
        }

    });    
</script>



<body class="flex min-h-screen items-center justify-center bg-[#f4f6f8]">
    <button type="button" id="goToLogin" class="p-4 bg-blue-200 rounded-sm">
        <svg class="w-6 h-6 text-gray-800 dark:text-white" aria-hidden="true" xmlns="http://www.w3.org/2000/svg"
            width="24" height="24" fill="none" viewBox="0 0 24 24">
            <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M5 12h14M5 12l4-4m-4 4 4 4" />
        </svg>
    </button>
    <div class="w-full max-w-md space-y-6 rounded-xl bg-white p-10 shadow-md">
        <div class="text-center">
            <h1 class="font-righteous mb-2 text-3xl text-[#6699ff]">UniLife</h1>
            <h2 class="text-xl font-semibold text-gray-700">íšŒì›ê°€ì…</h2>
        </div>

        <form id="signupForm" th:action="@{/signup}" method="post" class="space-y-4">

            <!-- ì•„ì´ë”” ì…ë ¥ + ì¤‘ë³µ í™•ì¸ -->
            <div>
                <label class="block text-sm font-medium text-gray-900">ì•„ì´ë””(í•™ë²ˆ)</label>
                <div class="flex gap-2">
                    <input id="userId" type="text" name="userId"
                        class="flex-1 rounded-md border px-4 py-2 focus:ring-2 focus:ring-[#6699ff]"
                        placeholder="ìˆ«ìë§Œ ì…ë ¥" />
                    <button type="button" id="checkIdBtn"
                        class="rounded-2xl bg-[#e0eaff] px-3 text-sm text-gray-700">ì¤‘ë³µí™•ì¸</button>
                </div>
                <div id="idCheckResult" class="text-sm mt-1"></div>
            </div>

            <!-- ì´ë©”ì¼ ì¸ì¦ -->
            <div>
                <label class="block text-sm font-medium text-gray-900">ì´ë©”ì¼</label>
                <div class="flex gap-2 mt-1">
                    <input id="email" type="text" name="email"
                        class="flex-1 rounded-md border px-4 py-2 focus:ring-2 focus:ring-[#6699ff]" />
                    <button type="button" id="sendEmailBtn"
                        class="rounded-2xl bg-[#e0eaff] px-3 text-sm text-gray-700">ì¸ì¦ì½”ë“œ ì „ì†¡</button>
                </div>
                <div class="flex gap-2 mt-2">
                    <input id="authCode" type="text"
                        class="w-1/2 rounded-md border px-4 py-2 text-sm focus:ring-2 focus:ring-[#6699ff]"
                        placeholder="ì¸ì¦ë²ˆí˜¸ ì…ë ¥" />
                    <button type="button" id="verifyEmailBtn"
                        class="rounded-2xl bg-cyan-100 px-3 text-sm text-gray-600">í™•ì¸</button>
                </div>
                <div id="emailVerifyResult" class="text-sm mt-1"></div>
            </div>


            <div>
                <label class="block text-sm font-medium text-gray-900">ì´ë¦„</label>
                <input type="text" name="username"
                    class="mt-1 w-full rounded-md border px-4 py-2 focus:ring-2 focus:ring-[#6699ff] focus:outline-none" />
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-900">í•™ê³¼</label>
                <input type="text" name="department"
                    class="mt-1 w-full rounded-md border px-4 py-2 focus:ring-2 focus:ring-[#6699ff] focus:outline-none" />
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-900">ë¹„ë°€ë²ˆí˜¸</label>
                <input type="password" name="password"
                    class="mt-1 w-full rounded-md border px-4 py-2 focus:ring-2 focus:ring-[#6699ff] focus:outline-none" />
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-900">ë¹„ë°€ë²ˆí˜¸ í™•ì¸</label>
                <input type="password" name="passwordck"
                    class="mt-1 w-full rounded-md border px-4 py-2 focus:ring-2 focus:ring-[#6699ff] focus:outline-none" />
                <div th:if="${param.pwError}" class="text-sm text-red-500">ë¹„ë°€ë²ˆí˜¸ë¥¼ ë‹¤ì‹œ í™•ì¸í•˜ì„¸ìš”.</div>
                <div th:if="${param.pwSuccess}" class="text-sm text-green-500">ì˜¬ë°”ë¥¸ ë¹„ë°€ë²ˆí˜¸ ì…ë‹ˆë‹¤.</div>
            </div>

            <button type="submit" id="signupBtn"
                class="w-full rounded-md bg-[#6699ff] py-2 text-white transition hover:bg-[#4d7fe5] disabled:bg-gray-300 disabled:cursor-not-allowed"
                disabled>
                íšŒì›ê°€ì…
            </button>
            <!-- í¼ ë‚´ë¶€ì— ì¶”ê°€ -->
            <input type="hidden" id="emailVerified" name="emailVerified" value="false" />

        </form>
    </div>

</body>

</html>