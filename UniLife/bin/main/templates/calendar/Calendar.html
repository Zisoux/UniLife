<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UniLife - ì¼ì • ê´€ë¦¬</title>
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@5.10.1/main.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.10.1/main.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link rel="stylesheet" th:href="@{/css/calendar.css}">
</head>
<body>

    <!-- ìƒë‹¨ ë¡œê³  -->
    <div id="logo">UniLife</div>

    <!-- ìº˜ë¦°ë”, ì¼ì • ëª©ë¡ì„ ìœ„í•œ ì»¨í…Œì´ë„ˆ -->
    <div id="container">
        <div id="calendar"></div> <!-- FullCalendar ìº˜ë¦°ë” -->
        <div id="event-panel">
            <h3>ğŸ“… ì¼ì • ëª©ë¡</h3>
            <ul id="event-list"></ul>

            <!-- ì¼ì • ì¶”ê°€ ë²„íŠ¼ -->
            <button id="add-event-btn" style="display: none;">ì¼ì • ì¶”ê°€</button>

            <!-- ì¼ì • ì¶”ê°€ í¼ -->
            <div id="event-form" style="display: none;">
                <h4>ì¼ì • ì¶”ê°€</h4>
                <label>ì œëª©: <input type="text" id="event-title"></label><br>
                <label>ì‹œì‘ ì‹œê°„: <input type="datetime-local" id="event-start-time"></label><br>
                <label>ì¢…ë£Œ ì‹œê°„: <input type="datetime-local" id="event-end-time"></label><br>
                <label>ì¥ì†Œ: <input type="text" id="event-location"></label><br>
                <label><input type="checkbox" id="event-alertcheck"> ì•Œë¦¼ ì„¤ì •</label><br>
                <button onclick="saveEvent()">ì €ì¥</button>
                <button onclick="closeForm()">ì·¨ì†Œ</button>
            </div>
        </div>
    </div>

    <!-- ì¼ì • ìƒì„¸ ì •ë³´ í‘œì‹œ ì˜ì—­ -->
    <div id="event-details"></div>

    <script>
        let selectedDate = null;

        // "ì¼ì • ì¶”ê°€" ë²„íŠ¼ í´ë¦­ ì‹œ í¼ ì—´ê¸°
        document.getElementById('add-event-btn').addEventListener('click', function () {
            document.getElementById('event-form').style.display = "block";
        });

        // ì¼ì • ì¶”ê°€ í¼ ë‹«ê¸°
        function closeForm() {
            document.getElementById('event-form').style.display = "none";
        }

        // ì¼ì • ë¶ˆëŸ¬ì˜¤ê¸°
        function loadEvents(date) {
            fetch(`/api/calendar/events?date=${date}`)
                .then(response => response.json())
                .then(events => {
                    const eventList = document.getElementById('event-list');
                    eventList.innerHTML = ""; // ê¸°ì¡´ ëª©ë¡ ì‚­ì œ
                    events.forEach(event => {
                        const li = document.createElement('li');
                        const startTime = new Date(event.start);
                        const formattedTime = startTime.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', hour12: true }); // x:xx AM/PM í˜•ì‹
                        li.textContent = `${event.title} (${formattedTime})`;  // ì¼ì • ì œëª© + ì‹œì‘ ì‹œê°„ í‘œì‹œ
                        eventList.appendChild(li);
                    });
                });
        }

        // ì¼ì • ì €ì¥
        function saveEvent() {
            const title = document.getElementById('event-title').value;
            const startTime = document.getElementById('event-start-time').value;
            const endTime = document.getElementById('event-end-time').value;
            const location = document.getElementById('event-location').value;
            const alertcheck = document.getElementById('event-alertcheck').checked;

            if (!title || !startTime || !endTime) {
                window.alert("ì¼ì • ì œëª©ê³¼ ì‹œê°„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!");
                return;
            }

            // startTimeì—ì„œ ë‚ ì§œë§Œ ì¶”ì¶œ (ì‹œê°„ ì •ë³´ëŠ” ì œì™¸)
            const date = startTime.split('T')[0];  // startTimeì€ 'YYYY-MM-DDTHH:mm' í˜•íƒœì¼ ê²½ìš°

            fetch('/api/events/add', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    title: title,
                    date: date,
                    start: startTime,
                    end: endTime,
                    location: location,
                    alertcheck: alertcheck
                })
            })
            .then(response => response.json())
            .then(data => {
                window.alert(data.message);
                closeForm();

                // FullCalendarì— ìƒˆ ì¼ì • ì¶”ê°€
                const calendarEl = document.getElementById('calendar');
                const calendar = FullCalendar.Calendar.getInstance(calendarEl); // ìº˜ë¦°ë” ì¸ìŠ¤í„´ìŠ¤ ê°€ì ¸ì˜¤ê¸°
                calendar.addEvent({
                    title: title,
                    date: date,
                    start: startTime,
                    end: endTime,
                    location: location,
                    alertcheck: alertcheck
                });

                loadEvents(selectedDate); // ì¼ì • ë‹¤ì‹œ ë¶ˆëŸ¬ì˜¤ê¸°
            });
        }

        // ìº˜ë¦°ë” ì„¤ì •
        document.addEventListener('DOMContentLoaded', function () {
            var calendarEl = document.getElementById('calendar');
            var calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                events: '/api/calendar/events', 
                selectable: true,
                editable: true,
                dateClick: function(info) {
                    selectedDate = info.dateStr;
                    loadEvents(selectedDate); // í´ë¦­í•œ ë‚ ì§œì˜ ì¼ì • ë¶ˆëŸ¬ì˜¤ê¸°
                    document.getElementById('add-event-btn').style.display = "block"; // ì¼ì • ì¶”ê°€ ë²„íŠ¼ í‘œì‹œ
                },
                eventClick: function(info) {
                    const event = info.event;
                    displayEventDetails(event); // í´ë¦­í•œ ì¼ì • ì •ë³´ í‘œì‹œ
                },
                eventTimeFormat: { // 3:21 AM í˜•ì‹ìœ¼ë¡œ ì¶œë ¥
                    hour: '2-digit',
                    minute: '2-digit',
                    hour12: true
                }
            });
            calendar.render();
        });

        // ì¼ì • í´ë¦­ ì‹œ ì „ì²´ ì •ë³´ í‘œì‹œ
        function displayEventDetails(event) {
            const eventDetails = document.getElementById('event-details');
            
            // ê¸°ì¡´ ë‚´ìš© ì‚­ì œ
            eventDetails.innerHTML = ` 
                <h4>ì¼ì • ì œëª©: ${event.title}</h4>
                <p>ì‹œì‘ ì‹œê°„: ${event.start.toLocaleString()}</p>
                <p>ì¢…ë£Œ ì‹œê°„: ${event.end ? event.end.toLocaleString() : 'ë¯¸ì •'}</p>
                <p>ì¥ì†Œ: ${event.extendedProps.location || 'ì •ë³´ ì—†ìŒ'}</p>
                <p>ì•Œë¦¼ ì„¤ì •: ${event.extendedProps.alertcheck ? 'ì„¤ì •ë¨' : 'ì—†ìŒ'}</p>
            `;
            eventDetails.style.display = "block"; // ì •ë³´ ì˜ì—­ ë³´ì´ê¸°
        }

        // ì¼ì • ì •ë³´ í‘œì‹œ ì˜ì—­ ìˆ¨ê¸°ê¸°
        function closeEventDetails() {
            const eventDetails = document.getElementById('event-details');
            eventDetails.style.display = "none";
        }
    </script>
</body>
</html>
