<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UniLife - 일정 관리</title>
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@5.10.1/main.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.10.1/main.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link rel="stylesheet" th:href="@{/css/calendar.css}">
</head>
<body>

    <!-- 상단 로고 -->
    <div id="logo">UniLife</div>

    <!-- 캘린더, 일정 목록을 위한 컨테이너 -->
    <div id="container">
        <div id="calendar"></div> <!-- FullCalendar 캘린더 -->
        <div id="event-panel">
            <h3>📅 일정 목록</h3>
            <ul id="event-list"></ul>

            <!-- 일정 추가 버튼 -->
            <button id="add-event-btn" style="display: none;">일정 추가</button>

            <!-- 일정 추가 폼 -->
            <div id="event-form" style="display: none;">
                <h4>일정 추가</h4>
                <label>제목: <input type="text" id="event-title"></label><br>
                <label>시작 시간: <input type="datetime-local" id="event-start-time"></label><br>
                <label>종료 시간: <input type="datetime-local" id="event-end-time"></label><br>
                <label>장소: <input type="text" id="event-location"></label><br>
                <label><input type="checkbox" id="event-alertcheck"> 알림 설정</label><br>
                <button onclick="saveEvent()">저장</button>
                <button onclick="closeForm()">취소</button>
            </div>
        </div>
    </div>

    <!-- 일정 상세 정보 표시 영역 -->
    <div id="event-details"></div>

    <script>
        let selectedDate = null;

        // "일정 추가" 버튼 클릭 시 폼 열기
        document.getElementById('add-event-btn').addEventListener('click', function () {
            document.getElementById('event-form').style.display = "block";
        });

        // 일정 추가 폼 닫기
        function closeForm() {
            document.getElementById('event-form').style.display = "none";
        }

        // 일정 불러오기
        function loadEvents(date) {
            fetch(`/api/calendar/events?date=${date}`)
                .then(response => response.json())
                .then(events => {
                    const eventList = document.getElementById('event-list');
                    eventList.innerHTML = ""; // 기존 목록 삭제
                    events.forEach(event => {
                        const li = document.createElement('li');
                        const startTime = new Date(event.start);
                        const formattedTime = startTime.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', hour12: true }); // x:xx AM/PM 형식
                        li.textContent = `${event.title} (${formattedTime})`;  // 일정 제목 + 시작 시간 표시
                        eventList.appendChild(li);
                    });
                });
        }

        // 일정 저장
        function saveEvent() {
            const title = document.getElementById('event-title').value;
            const startTime = document.getElementById('event-start-time').value;
            const endTime = document.getElementById('event-end-time').value;
            const location = document.getElementById('event-location').value;
            const alertcheck = document.getElementById('event-alertcheck').checked;

            if (!title || !startTime || !endTime) {
                window.alert("일정 제목과 시간을 입력해주세요!");
                return;
            }

            // startTime에서 날짜만 추출 (시간 정보는 제외)
            const date = startTime.split('T')[0];  // startTime은 'YYYY-MM-DDTHH:mm' 형태일 경우

            fetch('/api/events/add', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    title: title,
                    date: date,
                    start: startTime,
                    end: endTime,
                    location: location,
                    alertcheck: alertcheck
                })
            })
            .then(response => response.json())
            .then(data => {
                window.alert(data.message);
                closeForm();

                // FullCalendar에 새 일정 추가
                const calendarEl = document.getElementById('calendar');
                const calendar = FullCalendar.Calendar.getInstance(calendarEl); // 캘린더 인스턴스 가져오기
                calendar.addEvent({
                    title: title,
                    date: date,
                    start: startTime,
                    end: endTime,
                    location: location,
                    alertcheck: alertcheck
                });

                loadEvents(selectedDate); // 일정 다시 불러오기
            });
        }

        // 캘린더 설정
        document.addEventListener('DOMContentLoaded', function () {
            var calendarEl = document.getElementById('calendar');
            var calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                events: '/api/calendar/events', 
                selectable: true,
                editable: true,
                dateClick: function(info) {
                    selectedDate = info.dateStr;
                    loadEvents(selectedDate); // 클릭한 날짜의 일정 불러오기
                    document.getElementById('add-event-btn').style.display = "block"; // 일정 추가 버튼 표시
                },
                eventClick: function(info) {
                    const event = info.event;
                    displayEventDetails(event); // 클릭한 일정 정보 표시
                },
                eventTimeFormat: { // 3:21 AM 형식으로 출력
                    hour: '2-digit',
                    minute: '2-digit',
                    hour12: true
                }
            });
            calendar.render();
        });

        // 일정 클릭 시 전체 정보 표시
        function displayEventDetails(event) {
            const eventDetails = document.getElementById('event-details');
            
            // 기존 내용 삭제
            eventDetails.innerHTML = ` 
                <h4>일정 제목: ${event.title}</h4>
                <p>시작 시간: ${event.start.toLocaleString()}</p>
                <p>종료 시간: ${event.end ? event.end.toLocaleString() : '미정'}</p>
                <p>장소: ${event.extendedProps.location || '정보 없음'}</p>
                <p>알림 설정: ${event.extendedProps.alertcheck ? '설정됨' : '없음'}</p>
            `;
            eventDetails.style.display = "block"; // 정보 영역 보이기
        }

        // 일정 정보 표시 영역 숨기기
        function closeEventDetails() {
            const eventDetails = document.getElementById('event-details');
            eventDetails.style.display = "none";
        }
    </script>
</body>
</html>
