<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>UniLife GPA Í¥ÄÎ¶¨</title>
  <link rel="stylesheet" href="/css/gpa.css">
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <!-- Noto Sans KR (ÌïúÍ∏ÄÏö©) -->
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR&display=swap" rel="stylesheet">
  <!-- Righteous (ÏòÅÎ¨∏Ïö©) -->
  <link href="https://fonts.googleapis.com/css2?family=Righteous&display=swap" rel="stylesheet">
  
  <script>
	function goToSemester(button) {
	    const semesterId = button.dataset.semester;
	    const userId = document.getElementById("sessionUserId").innerText.trim();

	    if (semesterId === "all") {
	        // Ï†ÑÏ≤¥ÌïôÍ∏∞Î©¥ POSTÎ°ú GPA ÏóÖÎç∞Ïù¥Ìä∏ ÏöîÏ≤≠
	        fetch(`/gpa/update?userId=${userId}&semesterId=${semesterId}`, { method: 'POST' })
	            .then(response => {
	                if (response.ok) {
	                    window.location.href = `/gpa/view?userId=${userId}&semesterId=${semesterId}`;
	                } else {
	                    alert('GPA ÏóÖÎç∞Ïù¥Ìä∏ Ïã§Ìå®!');
	                }
	            })
	            .catch(error => {
	                console.error('Error:', error);
	                alert('ÏöîÏ≤≠ Ï§ë Ïò§Î•ò Î∞úÏÉù');
	            });
	    } else {
	        // ÎÇòÎ®∏ÏßÄ ÌïôÍ∏∞Îäî Í∑∏ÎÉ• Î∞îÎ°ú Ïù¥Îèô
	        window.location.href = `/gpa/view?userId=${userId}&semesterId=${semesterId}`;
	    }
	}


    window.onload = function () {
      document.querySelectorAll('.delete-button').forEach(button => {
        button.addEventListener('click', function () {
          const courseId = this.dataset.id;
          if (confirm("Ï†ïÎßê ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?")) {
            fetch(`/gpa/delete?courseId=${courseId}`, { method: 'GET' })
              .then(res => {
                if (res.ok) this.closest('tr').remove();
                else alert('ÏÇ≠Ï†ú Ïã§Ìå®');
              })
              .catch(() => alert('ÏÇ≠Ï†ú ÏöîÏ≤≠Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.'));
          }
        });
      });
    }
	
	function openModal(button) {
	  const semesterId = "all"; // Ï†ÑÏ≤¥ÌïôÍ∏∞
	  const userId = document.getElementById("sessionUserId").innerText.trim();

	  // 1. Î®ºÏ†Ä Ï†ÑÏ≤¥ÌïôÍ∏∞ ÏóÖÎç∞Ïù¥Ìä∏ POST
	  fetch(`/gpa/update?userId=${userId}&semesterId=${semesterId}`, { method: 'POST' })
	    .then(response => {
	      if (!response.ok) throw new Error('Ï†ÑÏ≤¥ÌïôÍ∏∞ ÏóÖÎç∞Ïù¥Ìä∏ Ïã§Ìå®');

	      // 2. Í∑∏ Îã§Ïùå Ï†ÑÏ≤¥ÌïôÍ∏∞ GPA Í∞ÄÏ†∏Ïò§Í∏∞
	      return fetch(`/gpa/allSemester?userId=${userId}`);
	    })
	    .then(response => response.json())
	    .then(data => {
	      if (data) {
	        document.getElementById("totalCredits").innerText = data.totalCredits ?? "-";
	        document.getElementById("majorCredits").innerText = data.majorCredits ?? "-";
	        document.getElementById("electiveCredits").innerText = data.electiveCredits ?? "-";

	        document.getElementById("totalGpa").innerText = (data.totalGpa ?? 0).toFixed(2);
	        document.getElementById("majorGpa").innerText = (data.majorGpa ?? 0).toFixed(2);
	        document.getElementById("electiveGpa").innerText = (data.electiveGpa ?? 0).toFixed(2);
	      }
	      // 3. ÎßàÏßÄÎßâÏóê Î™®Îã¨ Ïó¥Í∏∞
	      document.getElementById("myModal").style.display = "block";
	    })
	    .catch(error => {
	      console.error('Error:', error);
	      alert('GPA Ï†ïÎ≥¥ Í∞ÄÏ†∏Ïò§Í∏∞ Ïã§Ìå®!');
	    });
	}




	function closeModal() {
	 	document.getElementById("myModal").style.display = "none";
	}
	
  </script>
</head>
<body>
  <span id="sessionUserId" th:text="${session.userId}" hidden>202345011</span>

  <div class="container">
	<!-- ÏÉÅÎã® Í≥†Ï†ï Î∞î -->
	<header class="topbar">
	  <div class="topbar-left">UniLife</div>
	  <div class="topbar-right">
		<span class="topbar-date">
		  <span th:text="${todayDate}">2025-04-16</span>, 
		  <span th:text="${dayOfWeek}">ÏàòÏöîÏùº</span>
		</span>
	    <span class="topbar-user">Ïù¥Ïú†ÏßÑ</span>
	  </div>
	</header>

    <!--<div class="sidebar">
      <h2>ÏÇ¨Ïö©Ïûê Ï†ïÎ≥¥</h2>
      <p><strong>Ïù¥Î¶Ñ:</strong> <span th:text="${session.username}">Ïù¥Ïú†ÏßÑ</span></p>
      <p><strong>ÌïôÎ≤à:</strong> <span th:text="${session.userId}">202345011</span></p>
      <p><strong>ÌïôÍ≥º:</strong> <span th:text="${session.department}">Ïª¥Ìì®ÌÑ∞ÏãúÏä§ÌÖúÍ≥µÌïô</span></p>
    </div>-->

    <div class="main-content">
      <!--<h1 style="margin-bottom: 15px;">ÌïôÏ†ê Ï†ïÎ≥¥</h1>-->
      <div class="semester-tabs">
        <button class="semester-tab" data-semester="all" th:classappend="${semesterId} == 'all' ? 'active' : ''" onclick="openModal(this)">Ï†ÑÏ≤¥ÌïôÍ∏∞</button>
        <button class="semester-tab" data-semester="1-1" th:classappend="${semesterId} == '1-1' ? 'active' : ''" onclick="goToSemester(this)">1-1</button>
        <button class="semester-tab" data-semester="1-2" th:classappend="${semesterId} == '1-2' ? 'active' : ''" onclick="goToSemester(this)">1-2</button>
        <button class="semester-tab" data-semester="2-1" th:classappend="${semesterId} == '2-1' ? 'active' : ''" onclick="goToSemester(this)">2-1</button>
        <button class="semester-tab" data-semester="2-2" th:classappend="${semesterId} == '2-2' ? 'active' : ''" onclick="goToSemester(this)">2-2</button>
        <button class="semester-tab" data-semester="3-1" th:classappend="${semesterId} == '3-1' ? 'active' : ''" onclick="goToSemester(this)">3-1</button>
        <button class="semester-tab" data-semester="3-2" th:classappend="${semesterId} == '3-2' ? 'active' : ''" onclick="goToSemester(this)">3-2</button>
        <button class="semester-tab" data-semester="4-1" th:classappend="${semesterId} == '4-1' ? 'active' : ''" onclick="goToSemester(this)">4-1</button>
        <button class="semester-tab" data-semester="4-2" th:classappend="${semesterId} == '4-2' ? 'active' : ''" onclick="goToSemester(this)">4-2</button>
      </div>
	  
	  <!-- Î™®Îã¨ -->
	  <div id="myModal" class="modal">
	    <div class="modal-content">
	      <span class="close" onclick="closeModal()">&times;</span>
	      <h2>Ï†ÑÏ≤¥ÌïôÍ∏∞</h2>
	      <table class="allTable" style="margin: 10px auto 10px auto;">
	        <thead>
	          <tr>
	            <th>Ï†ÑÏ≤¥ÌïôÏ†ê</th>
	            <th>Ï†ÑÍ≥µÌïôÏ†ê</th>
	            <th>ÍµêÏñëÌïôÏ†ê</th>					
	          </tr>
	        </thead>
	        <tbody>
	          <tr>
	            <td id="totalCredits">-</td>
	            <td id="majorCredits">-</td>
	            <td id="electiveCredits">-</td>
	          </tr>
	        </tbody>
	      </table>

	      <table class="allTable" style="margin: 10px auto 10px auto;">
	        <thead>
	          <tr>
	            <th>Ï†ÑÏ≤¥ÏÑ±Ï†Å</th>
	            <th>Ï†ÑÍ≥µÏÑ±Ï†Å</th>
	            <th>ÍµêÏñëÏÑ±Ï†Å</th>					
	          </tr>
	        </thead>
	        <tbody>
	          <tr>
	            <td id="totalGpa" style="color: #6699ff; font-family: Righteous;">-</td>
	            <td id="majorGpa" style="color: #6699ff; font-family: Righteous;">-</td>
	            <td id="electiveGpa" style="color: #6699ff; font-family: Righteous;">-</td>
	          </tr>
	        </tbody>
	      </table>
	    </div>
	  </div>

      <div class="gpa-info">
        <div class="credits-item">
          <label>Ï†ÑÏ≤¥ÌïôÏ†ê</label>
          <span th:text="${gpa.totalCredits}">14</span>
        </div>
        <div class="credits-item">
          <label>Ï†ÑÍ≥µÌïôÏ†ê</label>
          <span th:text="${gpa.majorCredits}">9</span>
        </div>
        <div class="credits-item">
          <label>ÍµêÏñëÌïôÏ†ê</label>
          <span th:text="${gpa.electiveCredits}">5</span>
        </div>
		<div class="gpa-item">
		  <label>Ï†ÑÏ≤¥ÏÑ±Ï†Å</label>
		  <div class="score-wrapper">
		  	<span class="score" th:text="${gpa.totalGpa}">3.92</span>
		  	<span class="score-change" th:text="${gpa.totalChange}" th:style="${gpa.totalChange >= 0} ? 'color: green;' : 'color: red;'">+0.12</span>
		  </div>	
		</div>
		<div class="gpa-item">
		  <label>Ï†ÑÍ≥µÏÑ±Ï†Å</label>
		  <div class="score-wrapper">
		  	<span class="score" th:text="${gpa.majorGpa}">3.75</span>
		  	<span class="score-change" th:text="${gpa.majorChange}" th:style="${gpa.majorChange >= 0} ? 'color: green;' : 'color: red;'">-0.05</span>
		  </div>
		</div>
		<div class="gpa-item">
		  <label>ÍµêÏñëÏÑ±Ï†Å</label>
		  <div class="score-wrapper">
		  	<span class="score" th:text="${gpa.electiveGpa}">4.25</span>
		  	<span class="score-change" th:text="${gpa.electiveChange}" th:style="${gpa.electiveChange >= 0} ? 'color: green;' : 'color: red;'">+0.20</span>
		  </div>	
		</div>
      </div>

	  <div class="gpa-statistics">
	      <form th:action="@{/gpa/update}" method="post">
	          <table>
	              <thead>
	                  <tr>
	                      <th>Í≥ºÎ™©Î™Ö</th>
	                      <th>ÌïôÏ†ê</th>
	                      <th>ÏÑ±Ï†Å</th>
	                      <th>Ï†ÑÍ≥µÏó¨Î∂Ä</th>
	                      <th>ÏÇ≠Ï†ú</th>
	                  </tr>
	              </thead>
	              <tbody>
	                  <tr th:each="course : ${enrolledCourses}">
	                      <td>
	                          <!-- ÏàòÏ†ïÎêú Î∂ÄÎ∂Ñ: course.idÍ∞Ä Ï†ïÏÉÅÏ†ÅÏúºÎ°ú Î†åÎçîÎßÅÎêòÎèÑÎ°ù ÏàòÏ†ï -->
	                          <input type="text" th:name="'courses[' + ${course.id} + '].courseName'" th:value="${course.courseName}" required>
	                      </td>
	                      <td>
	                          <input type="number" th:name="'courses[' + ${course.id} + '].credits'" th:value="${course.credits}" required>
	                      </td>
	                      <td>
	                          <select th:name="'courses[' + ${course.id} + '].grade'" required>
	                              <option value="A+" th:selected="${course.grade} == 4.5">A+</option>
	                              <option value="A0" th:selected="${course.grade} == 4.0">A0</option>
	                              <option value="B+" th:selected="${course.grade} == 3.5">B+</option>
	                              <option value="B0" th:selected="${course.grade} == 3.0">B0</option>
	                              <option value="C+" th:selected="${course.grade} == 2.5">C+</option>
	                              <option value="C0" th:selected="${course.grade} == 2.0">C0</option>
	                              <option value="D+" th:selected="${course.grade} == 1.5">D+</option>
	                              <option value="D0" th:selected="${course.grade} == 1.0">D0</option>
	                              <option value="F" th:selected="${course.grade} == 0">F</option>
	                          </select>
	                      </td>
	                      <td>
	                          <input type="checkbox" th:name="'courses[' + ${course.id} + '].isMajor'" th:checked="${course.isMajor}" />
	                      </td>
	                  </tr>
	              </tbody>
	          </table>
	          <div style="text-align: right; margin-top: 10px; margin-right: 100px;">
	              <button type="submit">üîÑ ÏÉàÎ°úÍ≥†Ïπ® (ÏàòÏ†ïÎ∞òÏòÅ)</button>
	          </div>
	      </form>
	  </div>

      <div class="input-form">
        <h2>Í≥ºÎ™©Îì±Î°ù</h2>
        <form action="/gpa/calculate" method="POST">
          <input type="hidden" name="userId" value="${session.userId}">
          <input type="hidden" name="semesterId" value="${session.semesterId}">
		  <table style="width: 100%; border-spacing: 10px;"> <!-- Í∞ÑÍ≤© Ï∂îÍ∞Ä -->
		      <tr>
		        <td style="width: 50%;">
		          <label for="courseName">Í≥ºÎ™©Î™Ö</label><br>
		          <input type="text" id="courseName" name="courseName" required 
		            style="width: 100%; padding: 8px; border: 1px solid #e2e6ee; border-radius: 6px;">
		        </td>
		        <td style="width: 50%;">
		          <label for="credits">ÌïôÏ†ê</label><br>
		          <input type="number" id="credits" name="credits" required 
		            style="width: 100%; padding: 8px; border: 1px solid #e2e6ee; border-radius: 6px;">
		        </td>
		      </tr>
		      <tr>
		        <td style="width: 50%;">
		          <label for="scoreLabel">ÏÑ±Ï†Å</label><br>
		          <select id="scoreLabel" name="scoreLabel" required 
		            style="width: 100%; padding: 8px; border: 1px solid #e2e6ee; border-radius: 6px;">
		            <option value="">ÏÑ±Ï†Å ÏÑ†ÌÉù</option>
		            <option value="A+">A+</option>
		            <option value="A0">A0</option>
		            <option value="B+">B+</option>
		            <option value="B0">B0</option>
		            <option value="C+">C+</option>
		            <option value="C0">C0</option>
		            <option value="D+">D+</option>
		            <option value="D0">D0</option>
		            <option value="F">F</option>
		            <option value="P">P</option>
		            <option value="NP">NP</option>
		          </select>
		        </td>
		        <td style="width: 50%;">
		          <label for="isMajor">Ï†ÑÍ≥µÍ≥ºÎ™©</label><br>
		          <input type="checkbox" id="isMajor" name="isMajor" 
		            style="transform: scale(1.3); margin-top: 12px;">
		        </td>
		      </tr>
		    </table>
		  <div style="text-align: right; margin-top: 10px; margin-right: 10px;">
          	<input type="submit" value="‚ûï Îì±Î°ù">
		  </div>	
        </form>
      </div>
    </div>
  </div>
</body>
</html>