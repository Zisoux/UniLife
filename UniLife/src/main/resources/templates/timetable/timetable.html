<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
  <meta charset="UTF-8" />
  <title>UniLife - í•™ê¸°ë³„ ì‹œê°„í‘œ</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR&family=Poetsen+One&family=Righteous&display=swap" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet" />

  <!-- TailwindCSS ë¶ˆëŸ¬ì˜¤ê¸° -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            noto: ["'Noto Sans KR'", 'sans-serif'],
            righteous: ["'Righteous'", 'cursive']
          },
          colors: {
            primary: '#6699FF',
            secondary: '#FF9933',
            tertiary: '#6ad46a'
          }
        }
      }
    };
  </script>

  <style>
    :root {
      --main-color: #6699ff;
    }
    html, body {
      height: 100%;
      overflow: hidden; /* ì „ì²´ í™”ë©´ ìŠ¤í¬ë¡¤ ë°©ì§€ */
    }
    body {
      font-family: 'Noto Sans KR', sans-serif;
      font-size: 13px;
    }
    main {
      height: calc(100vh - 64px);
      display: flex;
      gap: 0.5rem;
      padding: 1rem 1.5rem;
      box-sizing: border-box;
    }
    /* ì¹´ë“œ ë‚´ë¶€ì˜ .relative(íƒ€ì„í…Œì´ë¸” ë°°ê²½)ì„ í°ìƒ‰ìœ¼ë¡œ ê³ ì • */
    .card > div.relative {
      background-color: white !important;
    }
    /* ì™¼ìª½ í•™ê¸° íƒ­ì´ ì‹œê°„í‘œë¥¼ ê°€ë¦¬ëŠ” ë¶€ë¶„ì„ ë³´ì •í•˜ê¸° ìœ„í•´ ì•½ê°„ ì™¼ìª½ìœ¼ë¡œ ë°€ì–´ëƒ„ */
    .timetable-section {
      margin-left: 3.5rem; /* í•™ê¸° íƒ­(ì•½ 60px â‰ˆ 3.75rem)ë³´ë‹¤ ì‚´ì§ ë” ì™¼ìª½ìœ¼ë¡œ ì´ë™ */
    }
  </style>
</head>

<body class="font-['Noto_Sans_KR'] text-sm bg-gray-50 text-neutral-900">

  <!-- ìƒë‹¨ ê³µí†µ í—¤ë”(ë¡œê·¸ì¸ ì •ë³´ ë“±) -->
  <div th:replace="common/header :: header(${user.userId}, ${user.id})"></div>

  <!-- ì™¼ìª½ ìƒë‹¨ â€œí•™ê¸°â€ íƒ­ -->
  <div
    id="semesterTab"
    class="fixed left-0 bg-[#FF9933] text-white px-3 py-2 rounded-r cursor-pointer select-none z-[60] font-semibold text-sm flex items-center justify-center"
    style="width: 60px; height: 48px; top: 80px;"
    onclick="toggleSemesterPanel()">
    í•™ê¸°
  </div>

  <!-- ì™¼ìª½ ìƒë‹¨ í•™ê¸°ê´€ë¦¬ ìŠ¬ë¼ì´ë“œ íŒ¨ë„ -->
  <div
    id="semesterPanel"
    class="fixed left-0 bg-white shadow-lg p-4 transform -translate-x-full transition-transform duration-300 z-[70] flex flex-col"
    style="top: 80px; height: calc(100vh - 80px); width: 16rem;">
    <h2 class="text-lg font-bold mb-4 border-b pb-2">í•™ê¸° ê´€ë¦¬</h2>
    <div class="flex flex-col gap-6 flex-grow overflow-auto">
      <!-- ê¸°ì¡´ í•™ê¸° ë³´ê¸° -->
      <form method="get"
            th:action="@{/timetable/view/{userId}(userId=${userId})}"
            class="bg-gray-50 p-3 rounded-lg border border-gray-200 shadow-sm">
        <label class="block mb-2 text-sm font-medium text-gray-700">ğŸ“˜ ê¸°ì¡´ í•™ê¸° ë³´ê¸°</label>
        <div class="flex gap-2">
          <select name="semester" required class="flex-1 border rounded px-2 py-1 text-sm">
            <option value="" disabled selected>í•™ê¸° ì„ íƒ</option>
            <option th:each="sem : ${semesters}"
                    th:value="${sem}"
                    th:text="${sem}"></option>
          </select>
          <button class="px-3 py-1 rounded bg-blue-500 hover:bg-blue-600 text-white text-sm">ë³´ê¸°</button>
        </div>
      </form>

      <!-- ìƒˆ í•™ê¸° ë§Œë“¤ê¸° -->
      <form method="post"
            action="/timetable/create"
            class="bg-gray-50 p-3 rounded-lg border border-gray-200 shadow-sm">
        <input type="hidden" name="userId" th:value="${userId}" />
        <label class="block mb-2 text-sm font-medium text-gray-700">ğŸ†• ìƒˆ í•™ê¸° ë§Œë“¤ê¸°</label>
        <div class="flex gap-2">
          <select name="semester" required class="flex-1 border rounded px-2 py-1 text-sm">
            <option value="" disabled selected>í•™ê¸° ì„ íƒ</option>
            <option th:each="sem : ${predefinedSemesters}"
                    th:value="${sem}"
                    th:text="${sem}"></option>
          </select>
          <button class="px-3 py-1 rounded bg-green-500 hover:bg-green-600 text-white text-sm">ë§Œë“¤ê¸°</button>
        </div>
      </form>
    </div>
  </div>

  <!-- ìš°ì¸¡ í•˜ë‹¨ â€œê°•ì˜ ì¶”ê°€â€ ë²„íŠ¼ -->
  <button
    id="openSlideBtn"
    onclick="openForm()"
    class="fixed bottom-8 right-8 bg-[#6ad46a] text-white px-6 py-3 rounded-full shadow-lg hover:bg-green-600 transition z-50 font-semibold select-none">
    ê°•ì˜ ì¶”ê°€
  </button>

  <!-- ìš°ì¸¡ì—ì„œ ìŠ¬ë¼ì´ë“œë¡œ ë‚˜ì˜¤ëŠ” â€œê°•ì˜ ì¶”ê°€â€ í¼ -->
  <div
    id="slideForm"
    class="fixed top-0 right-0 h-full w-80 bg-white shadow-lg p-6 transform translate-x-full transition-transform duration-300 z-50 flex flex-col">
    <h2 class="text-lg font-bold mb-4">ê°•ì˜ ì¶”ê°€</h2>
    <form th:action="@{/timetable/add}"
          method="post"
          class="space-y-4 flex-grow overflow-auto">
      <input type="hidden" name="userId" th:value="${userId}" />
      <input type="hidden" name="semester" th:value="${semester}" />

      <label class="block text-sm font-medium">ê°•ì˜ ì„ íƒ</label>
      <select name="courseId"
              class="w-full border px-3 py-2 rounded-md focus:outline-none focus:ring-2 focus:ring-primary"
              required>
        <option th:each="course : ${courses}"
                th:value="${course.id}"
                th:text="${course.courseName + ' (' + course.professor + ')'}"></option>
      </select>

      <label class="block text-sm font-medium">ìš”ì¼</label>
      <select name="dayOfWeek"
              class="w-full border px-3 py-2 rounded-md focus:outline-none focus:ring-2 focus:ring-primary"
              required>
        <option th:each="day : ${dayList}"
                th:value="${day}"
                th:text="${day}"></option>
      </select>

      <label class="block text-sm font-medium">ì‹œì‘ ì‹œê°„</label>
      <input type="time"
             name="startTime"
             class="w-full border px-3 py-2 rounded-md focus:outline-none focus:ring-2 focus:ring-primary"
             required />

      <label class="block text-sm font-medium">ì¢…ë£Œ ì‹œê°„</label>
      <input type="time"
             name="endTime"
             class="w-full border px-3 py-2 rounded-md focus:outline-none focus:ring-2 focus:ring-primary"
             required />

      <button type="submit"
              class="bg-primary text-white w-full py-2 rounded-md hover:bg-blue-700 transition">
        ì¶”ê°€
      </button>
    </form>

    <button onclick="closeForm()"
            class="mt-4 flex items-center justify-center gap-2 text-gray-600 hover:text-red-600 hover:bg-red-100 rounded-md px-4 py-2 font-semibold transition-colors duration-300">
      <svg xmlns="http://www.w3.org/2000/svg"
           class="h-5 w-5"
           fill="none"
           viewBox="0 0 24 24"
           stroke="currentColor"
           stroke-width="2">
        <path stroke-linecap="round"
              stroke-linejoin="round"
              d="M6 18L18 6M6 6l12 12" />
      </svg>
      ë‹«ê¸°
    </button>
  </div>

  <main>
    <!-- ì¢Œì¸¡: ì‹œê°„í‘œ ì˜ì—­ -->
    <section class="timetable-section flex-1 overflow-hidden">
      <div class="card h-full flex flex-col">
        <h2 class="text-xl font-bold mb-2" th:text="${semester} + ' ì‹œê°„í‘œ'"></h2>

		<!-- ì‹œê°„í‘œ ì»¨í…Œì´ë„ˆ: ë†’ì´ 1536px (8ì‹œ~22ì‹œ, 14ì‹œê°„ * 96px) -->
		<div class="relative flex-1 border border-gray-300 overflow-hidden z-0"
		     style="background-color: white; height: 1536px;">

		  <!-- âœ… ìš”ì¼ í—¤ë”: ìƒë‹¨ ê³ ì • ë° ì •í™•í•œ ìœ„ì¹˜ ë§ì¶¤ -->
		  <div class="absolute top-0 left-0 w-full z-10"
		       style="height: 48px;">
		    <div class="grid grid-cols-[10%_90%] text-center text-sm font-bold bg-gray-100 border-b border-gray-300">
		      <div class="border-r py-2">ì‹œê°„</div>
		      <div class="grid grid-cols-5">
		        <div class="border-r py-2" th:each="day : ${dayList}" th:text="${day}"></div>
		      </div>
		    </div>
		  </div>

		  <!-- âœ… ì‹œê°„ ë¼ì¸ (48px ì•„ë˜ë¶€í„° ì‹œì‘) -->
		  <div class="absolute top-[32px] left-0 w-full">
		    <div th:each="hour : ${#numbers.sequence(8, 22)}"
		         class="grid grid-cols-[10%_90%] w-full border-b border-gray-200 text-xs text-center h-[96px]">
		      <div class="border-r pt-1" th:text="${hour + ':00'}"></div>
		      <div class="grid grid-cols-5">
		        <div th:each="i : ${#numbers.sequence(1, 5)}"
		             th:attr="data-day=${dayList[i-1]}"
		             onclick="openFormWithDay(this.dataset.day)"
		             class="border-r border-gray-100 cursor-pointer hover:bg-blue-100">
		        </div>
		      </div>
		    </div>
		  </div>

          <!-- ê°•ì˜ ë¸”ë¡ (ì ˆëŒ€ ìœ„ì¹˜) -->
          <div class="absolute inset-0">
            <div th:each="block : ${courseBlocks}"
                 class="absolute bg-blue-400 text-white rounded shadow text-xs overflow-hidden"
                 th:style="
                   'top:' + ${block.topPx} + 'px; ' +
                   'left:' + ${block.leftPercent} + '%; ' +
                   'height:' + ${block.heightPx} + 'px; ' +
                   'width:' + ${block.widthPercent} + '%; ' +
                   'z-index:50;'
                 ">
              <div th:if="${block.first}"
                   class="h-full px-1 py-1 text-[11px] text-center leading-tight"
                   style="display: flex; flex-direction: column; justify-content: flex-start; align-items: center; overflow: auto; white-space: normal;">
                <div class="font-bold truncate" th:text="${block.courseName}"></div>
                <div th:text="${block.startTime} + ' ~ ' + ${block.endTime}"></div>
                <a th:href="@{/timetable/delete/{id}(id=${block.courseId}, userId=${userId}, semester=${semester})}"
                   onclick="return confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?');"
                   class="text-[10px] underline mt-1"
                   style="color: #ffdddd;">
                  ì‚­ì œ
                </a>
              </div>
            </div>
          </div>

        </div>
      </div>
    </section>

    <!-- ìš°ì¸¡: ê³µê°• ë§¤ì¹­ ì˜ì—­ -->
    <aside class="w-[15%] flex flex-col justify-start">
      <div class="card p-2 bg-gray-50 rounded-lg shadow-md h-full flex flex-col">
        <h3 class="text-lg font-bold mb-2 text-primary">ê°™ì€ ê³µê°• ì¹œêµ¬</h3>
        <div class="flex justify-center gap-4 mb-2">
          <a th:each="day : ${dayList}"
             th:href="@{'/timetable/view/' + ${userId} + '?semester=' + ${semester} + '&day=' + ${day}}"
             th:text="${day}"
             th:classappend="${day == selectedDay} ?
               'bg-primary text-white rounded px-2 py-1 text-xs' :
               'text-primary hover:bg-primary hover:text-white rounded px-2 py-1 text-xs cursor-pointer'">
          </a>
        </div>
        <div th:if="${#lists.isEmpty(matchingFriends)}"
             class="text-center text-gray-500 italic flex-1 flex items-center justify-center text-xs">
          í•´ë‹¹ ìš”ì¼ì— ê³µê°•ì´ ê²¹ì¹˜ëŠ” ì¹œêµ¬ê°€ ì—†ìŠµë‹ˆë‹¤.
        </div>
        <div th:each="friend : ${matchingFriends}"
             class="friend-card bg-white rounded-lg shadow-md p-2 mb-2 hover:shadow-lg transition-shadow cursor-pointer text-xs">
          <strong class="block font-semibold text-primary mb-1" th:text="${friend.friendUsername}"></strong>
          <p class="text-gray-700" th:text="${friend.timeRangeSummary}"></p>
        </div>
      </div>
    </aside>
  </main>

  <script>
    function openSemesterPanel() {
      document.getElementById("semesterPanel").classList.remove("-translate-x-full");
      document.getElementById("semesterTab").style.display = "none";
    }
    function closeSemesterPanel() {
      document.getElementById("semesterPanel").classList.add("-translate-x-full");
      document.getElementById("semesterTab").style.display = "block";
    }
    function toggleSemesterPanel() {
      const panel = document.getElementById("semesterPanel");
      if (panel.classList.contains("-translate-x-full")) {
        openSemesterPanel();
      } else {
        closeSemesterPanel();
      }
    }

    // í•™ê¸° íŒ¨ë„ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
    document.addEventListener('click', function(event) {
      const semesterPanel = document.getElementById('semesterPanel');
      const semesterTab = document.getElementById('semesterTab');
      const isClickInsidePanel = semesterPanel.contains(event.target);
      const isClickOnTab     = semesterTab.contains(event.target);

      if (!semesterPanel.classList.contains('-translate-x-full')
          && !isClickInsidePanel
          && !isClickOnTab) {
        closeSemesterPanel();
      }
    });

    // â€œê°•ì˜ ì¶”ê°€â€ í¼ ì—´ê¸°/ë‹«ê¸°
    function openForm() {
      document.getElementById("slideForm").classList.remove("translate-x-full");
      document.querySelector('select[name="dayOfWeek"]').value = "";
    }
    function closeForm() {
      document.getElementById("slideForm").classList.add("translate-x-full");
    }
    function openFormWithDay(day) {
      openForm();
      document.querySelector('select[name="dayOfWeek"]').value = day;
    }
  </script>

</body>
</html>
