<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>UniLife í•™ì ê³„ì‚°ê¸°</title>

	<!-- Tailwind CSS CDN -->
	<script src="https://cdn.tailwindcss.com"></script>
	<script>
		tailwind.config = {
			theme: {
				extend: {
					colors: {
						primary: '#6699FF',
						secondary: '#FF9933',
						tertiary: '#6ad46a'
					},
					borderRadius: {
						'button': '8px'
					},
					fontFamily: {
						righteous: ["'Righteous'", 'cursive'],
						noto: ["'Noto Sans KR'", 'sans-serif']
					}
				}
			}
		};
	</script>
	<link rel="preconnect" href="https://fonts.googleapis.com">
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&family=Righteous&display=swap"
		rel="stylesheet">
	<link href="https://cdn.jsdelivr.net/npm/remixicon@4.5.0/fonts/remixicon.css" rel="stylesheet">
	<link href="https://cdn.jsdelivr.net/npm/fullcalendar@5.10.1/main.min.css" rel="stylesheet" />
	<script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.10.1/main.min.js" defer></script>
	<script src="https://unpkg.com/@popperjs/core@2" defer></script>
	<script src="https://unpkg.com/tippy.js@6" defer></script>
	<link rel="stylesheet" href="https://unpkg.com/tippy.js@6/themes/light.css" />
	<script src="https://code.jquery.com/jquery-3.6.0.min.js" defer></script>
	<style>
		body {
			font-family: 'Noto Sans KR', sans-serif;
			background-color: #F1F3F5;
			font-size: 13px;
		}

		.fc {
			font-family: 'Noto Sans KR', sans-serif;
			font-size: 13px;
		}

		.fc-toolbar-title {
			font-weight: 700;
		}

		.fc-event {
			font-size: 0.75rem;
			border-radius: 4px;
			padding: 2px 6px;
			color: #fff;
			background-color: inherit !important;
			border-color: inherit !important;
		}

		.fc-event-main,
		.fc-event-title,
		.fc-event-dot {
			background-color: inherit !important;
			color: inherit !important;
			border-color: inherit !important;
		}

		.fc .fc-button {
			border-radius: 6px;
			padding: 5px 10px;
			background-color: #6699FF;
			border: none;
			min-width: 90px;
			height: 34px;
			font-size: 0.825rem;
		}

		.fc .fc-button:hover {
			background-color: #4f83e3;
		}

		.fc-toolbar-chunk button {
			margin-right: 0.5rem;
		}

		html,
		body {
			height: 100%;
			overflow: hidden;
		}

		.main-content {
			height: calc(100vh - 64px);
			/* header ë†’ì´ë§Œí¼ ë¹¼ê¸° */
			overflow-y: auto;
		}

		.no-scrollbar::-webkit-scrollbar {
			display: none;
		}

		.no-scrollbar {
			-ms-overflow-style: none;
			/* IE/Edge */
			scrollbar-width: none;
			/* Firefox */
		}
	</style>
	<link rel="stylesheet" href="/css/gpa.css">

	<!-- Noto Sans KR (í•œê¸€ìš©) -->
	<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR&display=swap" rel="stylesheet">
	<!-- Righteous (ì˜ë¬¸ìš©) -->
	<link href="https://fonts.googleapis.com/css2?family=Righteous&display=swap" rel="stylesheet">

	<script>
		function goToSemester(button) {
			const semesterId = button.dataset.semester;
			const userId = document.getElementById("loginUserId").innerText.trim();

			if (semesterId === "all") {
				// ì „ì²´í•™ê¸°ë©´ POSTë¡œ GPA ì—…ë°ì´íŠ¸ ìš”ì²­
				fetch(`/gpa/update?userId=${userId}&semesterId=${semesterId}`, { method: 'POST' })
					.then(response => {
						if (response.ok) {
							window.location.href = `/gpa/view?userId=${userId}&semesterId=${semesterId}`;
						} else {
							alert('GPA ì—…ë°ì´íŠ¸ ì‹¤íŒ¨!');
						}
					})
					.catch(error => {
						console.error('Error:', error);
						alert('ìš”ì²­ ì¤‘ ì˜¤ë¥˜ ë°œìƒ');
					});
			} else {
				// ë‚˜ë¨¸ì§€ í•™ê¸°ë„ update í›„ ì´ë™
				fetch(`/gpa/update?userId=${userId}&semesterId=${semesterId}`, { method: 'POST' })
					.then(response => {
						if (response.ok) {
							window.location.href = `/gpa/view?userId=${userId}&semesterId=${semesterId}`;
						} else {
							alert('GPA ì—…ë°ì´íŠ¸ ì‹¤íŒ¨!');
						}
					})
					.catch(error => {
						console.error('Error:', error);
						alert('ìš”ì²­ ì¤‘ ì˜¤ë¥˜ ë°œìƒ');
					});
			}
		}


		window.onload = function () {
			// ì²« ë²ˆì§¸ delete ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
			document.querySelectorAll('.delete-button').forEach(button => {
				button.addEventListener('click', function () {
					const courseId = this.dataset.id;
					if (confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
						fetch(`/gpa/delete?courseId=${courseId}`, { method: 'GET' })
							.then(res => {
								if (res.ok) window.location.reload(); //this.closest('tr').remove();
								else alert('ì‚­ì œ ì‹¤íŒ¨');
							})
							.catch(() => alert('ì‚­ì œ ìš”ì²­ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.'));
					}
				});
			});

			// ë‘ ë²ˆì§¸ deleteAll ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
			document.querySelectorAll('.deleteALL-button').forEach(button => {
				button.addEventListener('click', function () {
					if (confirm("ì „ì²´ ë°ì´í„°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
						fetch(`/gpa/deleteAll?`, { method: 'GET' })
							.then(res => {
								if (res.ok) {
									alert('ì „ì²´ ë°ì´í„°ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
									// ëª¨ë‹¬ ë‹«ê¸°
									document.getElementById("myModal").style.display = "none";
									// GPA í˜ì´ì§€ë¡œ ì´ë™ (userId, semesterIdëŠ” í…œí”Œë¦¿ì—ì„œ ë°›ì•„ì™€ì•¼ í•¨)
									const userId = document.getElementById("loginUserId").innerText.trim();
									window.location.href = `/gpa/view?userId=${userId}&semesterId=1-1`;
								} else {
									alert('ì „ì²´ ì‚­ì œ ì‹¤íŒ¨');
								}
							})
							.catch(() => alert('ì‚­ì œ ìš”ì²­ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.'));
					}
				});
			});
		};


		function openModal(button) {
			const semesterId = "all"; // ì „ì²´í•™ê¸°
			const userId = document.getElementById("loginUserId").innerText.trim();

			// 1. ë¨¼ì € ì „ì²´í•™ê¸° ì—…ë°ì´íŠ¸ POST
			fetch(`/gpa/update?userId=${userId}&semesterId=${semesterId}`, { method: 'POST' })
				.then(response => {
					if (!response.ok) throw new Error('ì „ì²´í•™ê¸° ì—…ë°ì´íŠ¸ ì‹¤íŒ¨');

					// 2. ê·¸ ë‹¤ìŒ ì „ì²´í•™ê¸° GPA ê°€ì ¸ì˜¤ê¸°
					return fetch(`/gpa/allSemester?userId=${userId}`);
				})
				.then(response => response.json())
				.then(data => {
					if (data) {
						document.getElementById("totalCredits").innerText = data.totalCredits ?? "-";
						document.getElementById("majorCredits").innerText = data.majorCredits ?? "-";
						document.getElementById("electiveCredits").innerText = data.electiveCredits ?? "-";

						document.getElementById("totalGpa").innerText = (data.totalGpa ?? 0).toFixed(2);
						document.getElementById("majorGpa").innerText = (data.majorGpa ?? 0).toFixed(2);
						document.getElementById("electiveGpa").innerText = (data.electiveGpa ?? 0).toFixed(2);
					}
					// 3. ë§ˆì§€ë§‰ì— ëª¨ë‹¬ ì—´ê¸°
					document.getElementById("myModal").style.display = "block";
				})
				.catch(error => {
					console.error('Error:', error);
					alert('GPA ì •ë³´ ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨!');
				});
		}

		function closeModal() {
			document.getElementById("myModal").style.display = "none";
		}

		function toggleMajorCheckbox(courseId) {
			const grade = document.getElementById('grade-' + courseId).value;
			const majorCheckbox = document.getElementById('isMajor-' + courseId);
			if (grade === 'P' || grade === 'NP') {
				majorCheckbox.checked = false;
				majorCheckbox.disabled = true;
			} else {
				majorCheckbox.disabled = false;
			}
		}

		// í˜ì´ì§€ ë¡œë“œì‹œ P/NPì¸ ê²½ìš° ì²´í¬ë°•ìŠ¤ ë¹„í™œì„±í™”
		window.addEventListener('DOMContentLoaded', function () {
			document.querySelectorAll('select[id^="grade-"]').forEach(function (select) {
				const courseId = select.id.replace('grade-', '');
				toggleMajorCheckbox(courseId);
			});
		});

		function toggleMajorCheckboxForRegister() {
			const grade = document.getElementById('scoreLabel').value;
			const majorCheckbox = document.getElementById('isMajor');
			if (grade === 'P' || grade === 'NP') {
				majorCheckbox.checked = false;
				majorCheckbox.disabled = true;
			} else {
				majorCheckbox.disabled = false;
			}
		}
		// í˜ì´ì§€ ë¡œë“œì‹œì—ë„ ë°˜ì˜
		window.addEventListener('DOMContentLoaded', function () {
			toggleMajorCheckboxForRegister();
		});

	</script>
</head>

<body class="font-noto text-sm bg-white w-full min-h-screen no-scrollbar">

	<span id="loginUserId" th:text="${userId}" hidden>loginUserId</span>

	<div th:fragment="header(userId, id)">
		<header class="bg-[#6699ff] text-white shadow-sm w-full">
			<div class="max-w-screen-xl mx-auto px-6 py-4 flex justify-between items-center">

				<!-- ì™¼ìª½ ë¡œê³  -->
				<div class="text-2xl font-['Righteous'] tracking-wide">
					UniLife
				</div>

				<!-- ì˜¤ë¥¸ìª½: ë©”ë‰´ + ìœ ì €ì´ë¦„ + ë¡œê·¸ì•„ì›ƒ -->
				<div class="flex items-center gap-6 text-sm">

					<!-- ë©”ë‰´ -->
					<nav>
						<ul class="flex gap-6">
							<li><a th:href="@{/calendar}" class="hover:underline">ì¼ì •</a></li>
							<li><a th:href="@{/timetable/view/{id}(id=${id}, semester='2025-1í•™ê¸°')}"
									class="hover:underline">ì‹œê°„í‘œ</a></li>
							<li><a th:href="@{/portfolios}" class="hover:underline">í¬íŠ¸í´ë¦¬ì˜¤</a></li>
							<li><a th:href="@{/gpa/view(userId=${userId}, semesterId='1-1')}" class="hover:underline">í•™ì 
									ê³„ì‚°ê¸°</a></li>
							<li><a th:href="@{/friends/{userId}(userId=${userId})}" class="hover:underline">ì¹œêµ¬</a></li>
						</ul>
					</nav>

					<!-- ì‚¬ìš©ì ì´ë¦„ -->
					<span class="font-bold text-white">
						<a th:href="@{/mypage}" class="font-bold text-white hover:underline flex items-center">
							<i class="ri-user-line mr-1"></i>
							<span th:text="${username}">ë¡œê·¸ì¸í•œ ì‚¬ìš©ì</span>
						</a>
					</span>

					<!-- ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ -->
					<form th:action="@{/logout}" method="post">
						<button type="submit" class="text-xs hover:underline">ë¡œê·¸ì•„ì›ƒ</button>
					</form>

				</div>
			</div>
		</header>
	</div>

	<div class="flex w-full max-w-full min-h-[calc(100vh-64px)]">
		<main class="flex-1 overflow-y-auto bg-[#f4f6f8]">
			<div class="main-content">
				<!--<h1 style="margin-bottom: 15px;">í•™ì  ì •ë³´</h1>-->
				<div class="semester-tabs">
					<button class="semester-tab" data-semester="all"
						th:classappend="${semesterId} == 'all' ? 'active' : ''" onclick="openModal(this)">ì „ì²´í•™ê¸°</button>
					<button class="semester-tab" data-semester="1-1"
						th:classappend="${semesterId} == '1-1' ? 'active' : ''"
						onclick="goToSemester(this)">1-1</button>
					<button class="semester-tab" data-semester="1-2"
						th:classappend="${semesterId} == '1-2' ? 'active' : ''"
						onclick="goToSemester(this)">1-2</button>
					<button class="semester-tab" data-semester="2-1"
						th:classappend="${semesterId} == '2-1' ? 'active' : ''"
						onclick="goToSemester(this)">2-1</button>
					<button class="semester-tab" data-semester="2-2"
						th:classappend="${semesterId} == '2-2' ? 'active' : ''"
						onclick="goToSemester(this)">2-2</button>
					<button class="semester-tab" data-semester="3-1"
						th:classappend="${semesterId} == '3-1' ? 'active' : ''"
						onclick="goToSemester(this)">3-1</button>
					<button class="semester-tab" data-semester="3-2"
						th:classappend="${semesterId} == '3-2' ? 'active' : ''"
						onclick="goToSemester(this)">3-2</button>
					<button class="semester-tab" data-semester="4-1"
						th:classappend="${semesterId} == '4-1' ? 'active' : ''"
						onclick="goToSemester(this)">4-1</button>
					<button class="semester-tab" data-semester="4-2"
						th:classappend="${semesterId} == '4-2' ? 'active' : ''"
						onclick="goToSemester(this)">4-2</button>
				</div>

				<!-- ëª¨ë‹¬ -->
				<div id="myModal" class="modal">
					<div class="modal-content">
						<span class="close" onclick="closeModal()">&times;</span>
						<h2 class="text-lg font-bold mb-4">ì „ì²´í•™ê¸°</h2>
						<table class="allTable" style="margin: 10px auto 10px auto;">
							<thead>
								<tr>
									<th>ì „ì²´í•™ì </th>
									<th>ì „ê³µí•™ì </th>
									<th>êµì–‘í•™ì </th>
								</tr>
							</thead>
							<tbody>
								<tr>
									<td id="totalCredits">-</td>
									<td id="majorCredits">-</td>
									<td id="electiveCredits">-</td>
								</tr>
							</tbody>
						</table>

						<table class="allTable" style="margin: 10px auto 10px auto;">
							<thead>
								<tr>
									<th>ì „ì²´ì„±ì </th>
									<th>ì „ê³µì„±ì </th>
									<th>êµì–‘ì„±ì </th>
								</tr>
							</thead>
							<tbody>
								<tr>
									<td id="totalGpa" style="color: #6699ff; font-family: Righteous;">-</td>
									<td id="majorGpa" style="color: #6699ff; font-family: Righteous;">-</td>
									<td id="electiveGpa" style="color: #6699ff; font-family: Righteous;">-</td>
								</tr>
							</tbody>
						</table>
						<button class="deleteALL-button">ì „ì²´ê¸°ë¡ì‚­ì œ</button>
					</div>
				</div>

				<div class="gpa-info">
					<div class="credits-item">
						<label>ì „ì²´í•™ì </label>
						<span th:text="${gpa.totalCredits}">14</span>
					</div>
					<div class="credits-item">
						<label>ì „ê³µí•™ì </label>
						<span th:text="${gpa.majorCredits}">9</span>
					</div>
					<div class="credits-item">
						<label>êµì–‘í•™ì </label>
						<span th:text="${gpa.electiveCredits}">5</span>
					</div>
					<div class="gpa-item">
						<label>ì „ì²´ì„±ì </label>
						<div class="score-wrapper">
							<span class="score" th:text="${gpa.totalGpa}">3.92</span>
							<span class="score-change" th:text="${gpa.totalChange}"
								th:style="${gpa.totalChange >= 0} ? 'color: green;' : 'color: red;'">+0.12</span>
						</div>
					</div>
					<div class="gpa-item">
						<label>ì „ê³µì„±ì </label>
						<div class="score-wrapper">
							<span class="score" th:text="${gpa.majorGpa}">3.75</span>
							<span class="score-change" th:text="${gpa.majorChange}"
								th:style="${gpa.majorChange >= 0} ? 'color: green;' : 'color: red;'">-0.05</span>
						</div>
					</div>
					<div class="gpa-item">
						<label>êµì–‘ì„±ì </label>
						<div class="score-wrapper">
							<span class="score" th:text="${gpa.electiveGpa}">4.25</span>
							<span class="score-change" th:text="${gpa.electiveChange}"
								th:style="${gpa.electiveChange >= 0} ? 'color: green;' : 'color: red;'">+0.20</span>
						</div>
					</div>
				</div>

				<div class="gpa-statistics">
					<form th:action="@{/gpa/update}" method="post">
						<table>
							<thead>
								<tr>
									<th>ê³¼ëª©ëª…</th>
									<th>í•™ì </th>
									<th>ì„±ì </th>
									<th>ì „ê³µì—¬ë¶€</th>
									<th>ì‚­ì œ</th>
								</tr>
							</thead>
							<tbody>
								<tr th:each="course : ${enrolledCourses}">
									<td>
										<!-- ìˆ˜ì •ëœ ë¶€ë¶„: course.idê°€ ì •ìƒì ìœ¼ë¡œ ë Œë”ë§ë˜ë„ë¡ ìˆ˜ì • -->
										<input type="text" th:name="'courses[' + ${course.id} + '].courseName'"
											th:value="${course.courseName}" required>
									</td>
									<td>
										<input type="number" th:name="'courses[' + ${course.id} + '].credits'"
											th:value="${course.credits}" required>
									</td>
									<td>
										<select th:name="'courses[' + ${course.id} + '].grade'" required
											th:id="'grade-' + ${course.id}"
											th:onchange="'toggleMajorCheckbox(' + ${course.id} + ')'">
											<option value="A+"
												th:selected="${course.gradeType} == 'NORMAL' and ${course.grade} == 4.5">
												A+</option>
											<option value="A0"
												th:selected="${course.gradeType} == 'NORMAL' and ${course.grade} == 4.0">
												A0</option>
											<option value="B+"
												th:selected="${course.gradeType} == 'NORMAL' and ${course.grade} == 3.5">
												B+</option>
											<option value="B0"
												th:selected="${course.gradeType} == 'NORMAL' and ${course.grade} == 3.0">
												B0</option>
											<option value="C+"
												th:selected="${course.gradeType} == 'NORMAL' and ${course.grade} == 2.5">
												C+</option>
											<option value="C0"
												th:selected="${course.gradeType} == 'NORMAL' and ${course.grade} == 2.0">
												C0</option>
											<option value="D+"
												th:selected="${course.gradeType} == 'NORMAL' and ${course.grade} == 1.5">
												D+</option>
											<option value="D0"
												th:selected="${course.gradeType} == 'NORMAL' and ${course.grade} == 1.0">
												D0</option>
											<option value="F"
												th:selected="${course.gradeType} == 'NORMAL' and ${course.grade} == 0">F
											</option>
											<option value="P" th:selected="${course.gradeType} == 'P'">P</option>
											<option value="NP" th:selected="${course.gradeType} == 'NP'">NP</option>
										</select>
									</td>
									<td>
										<input type="checkbox" th:name="'courses[' + ${course.id} + '].isMajor'"
											th:checked="${course.isMajor}" th:id="'isMajor-' + ${course.id}" />
										<input type="hidden" th:name="'courses[' + ${course.id} + '].isMajor'"
											value="off" />
									</td>
									<td>
										<button type="button" class="delete-button" th:data-id="${course.id}" style="background-color: transparent;
						                                  border: none;
						                                  color: #ff5c5c;
						                                  cursor: pointer;
						                                  font-size: 1.2rem;">&#128465;</button>
									</td>
								</tr>
							</tbody>
						</table>
						<div style="text-align: right; margin-top: 10px; margin-right: 100px;">
							<button type="submit"
								class="bg-[#6AD46A] text-white px-5 py-2.5 text-base rounded-lg cursor-pointer transition duration-200 hover:bg-[#4d7cd5]">ğŸ”„
								ìƒˆë¡œê³ ì¹¨ (ìˆ˜ì •ë°˜ì˜)</button>
						</div>
					</form>
				</div>

				<div class="input-form">
					<h2 class="text-lg font-bold mb-4">ê³¼ëª©ë“±ë¡</h2>
					<form action="/gpa/calculate" method="POST">
						<input type="hidden" name="userId" value="${session.userId}">
						<input type="hidden" name="semesterId" value="${session.semesterId}">
						<table style="width: 100%; border-spacing: 10px;"> <!-- ê°„ê²© ì¶”ê°€ -->
							<tr>
								<td style="width: 50%;">
									<label for="courseName">ê³¼ëª©ëª…</label><br>
									<input type="text" id="courseName" name="courseName" required
										style="width: 100%; padding: 8px; border: 1px solid #e2e6ee; border-radius: 6px;">
								</td>
								<td style="width: 50%;">
									<label for="credits">í•™ì </label><br>
									<input type="number" id="credits" name="credits" required
										style="width: 100%; padding: 8px; border: 1px solid #e2e6ee; border-radius: 6px;">
								</td>
							</tr>
							<tr>
								<td style="width: 50%;">
									<label for="scoreLabel">ì„±ì </label><br>
									<select id="scoreLabel" name="scoreLabel" required
										style="width: 100%; padding: 8px; border: 1px solid #e2e6ee; border-radius: 6px;"
										onchange="toggleMajorCheckboxForRegister()">
										<option value="">ì„±ì  ì„ íƒ</option>
										<option value="A+">A+</option>
										<option value="A0">A0</option>
										<option value="B+">B+</option>
										<option value="B0">B0</option>
										<option value="C+">C+</option>
										<option value="C0">C0</option>
										<option value="D+">D+</option>
										<option value="D0">D0</option>
										<option value="F">F</option>
										<option value="P">P</option>
										<option value="NP">NP</option>
									</select>
								</td>
								<td style="width: 50%;">
									<label for="isMajor">ì „ê³µê³¼ëª©</label><br>
									<input type="checkbox" id="isMajor" name="isMajor"
										style="transform: scale(1.3); margin-top: 12px;">
								</td>
							</tr>
						</table>
						<div style="text-align: right; margin-top: 10px; margin-right: 10px;">
							<input type="submit"
								class="bg-[#6AD46A] text-white px-5 py-2.5 text-base rounded-lg cursor-pointer transition duration-200 hover:bg-[#4d7cd5]"
								value="â• ë“±ë¡">
						</div>
					</form>
				</div>
			</div>
		</main>
	</div>
</body>

</html>