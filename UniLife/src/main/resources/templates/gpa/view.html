<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GPA Calculator</title>
    <link rel="stylesheet" th:href="@{/css/gpa.css}">
	
	<script>
	    function goToSemester(button) {
	        const semesterId = button.dataset.semester;

	        // ✅ span 태그에서 값 읽어오기
	        const userId = document.getElementById("sessionUserId").innerText.trim();

	        const url = `/gpa/view?userId=${userId}&semesterId=${semesterId}`;
	        window.location.href = url;
	    }
		
		// 삭제 버튼 클릭 시, 해당 과목을 폼에서 삭제하는 함수
		window.onload = function() {
		    console.log('JavaScript Loaded'); // 페이지가 로드될 때 출력

			document.querySelectorAll('.delete-button').forEach(button => {
			    button.addEventListener('click', function() {
			        // 삭제할 과목의 ID 가져오기
			        const courseId = button.getAttribute('data-id');

			        // 사용자에게 삭제 확인을 요청
			        const isConfirmed = window.confirm("정말로 삭제하시겠습니까?");

			        if (isConfirmed) {
			            // 서버에 삭제 요청 보내기 (AJAX 사용)
			            fetch(`/gpa/delete?courseId=${courseId}`, {
			                method: 'GET',
			                headers: {
			                    'Content-Type': 'application/json'
			                }
			            })
			            .then(response => {
			                if (response.ok) {
			                    console.log('Course deleted successfully');
			                    const row = button.closest('tr');  // 삭제된 과목의 행을 찾음
			                    row.remove();  // 해당 행 삭제
			                } else {
			                    alert('삭제 실패');
			                }
			            })
			            .catch(error => {
			                console.error('Error during delete request:', error);
			                alert('삭제 요청에 실패했습니다.');
			            });
			        } else {
			            console.log('삭제가 취소되었습니다.');
			        }
			    });
			});
		};


	</script>
	
</head>
<body>
	<!-- 안전하게 Thymeleaf 값 삽입 -->
	<span id="sessionUserId" th:text="${session.userId}" hidden></span>
	<span id="sessionDepartment" th:text="${session.department}" hidden></span>

<div class="container">
    <!-- 왼쪽 사용자 정보 탭 -->
    <div class="sidebar">
        <h2>사용자 정보</h2>
        <p><strong>이름:</strong> <span th:text="${session.username ?: '정보 없음'}">이유진</span></p>
		<p><strong>학번:</strong> <span th:text="${session.userId ?: '정보 없음'}">202345011</span></p>
        <p><strong>학과:</strong> <span th:text="${session.department ?: '정보 없음'}">컴퓨터시스템공학</span></p>
    </div>

    <!-- 메인 콘텐츠 -->
    <div class="main-content">
        <h1 style="margin: 0px 10px 20px 10px;">학점 정보</h1>
		<hr style="margin: 0px 0px 10px 0px">
		
		<input type="hidden" id="userId" th:value="${gpa.userId}">

		<!-- 학기별 학점 정보 표시 -->
		<div class="semester-tabs">
			<button class="semester-tab" 
				data-semester="1-1" 
			    th:classappend="${semesterId == '1-1'} ? 'active' : ''"
			    onclick="goToSemester(this)">1학년 1학기</button>
			<button class="semester-tab" 
				data-semester="1-2" 
				th:classappend="${semesterId == '1-2'} ? 'active' : ''"
				onclick="goToSemester(this)">1학년 2학기</button>
			<button class="semester-tab" 
	            data-semester="2-1" 
	            th:classappend="${semesterId == '2-1'} ? 'active' : ''"
	            onclick="goToSemester(this)">2학년 1학기</button>
			<button class="semester-tab" 
	            data-semester="2-2" 
	            th:classappend="${semesterId == '2-2'} ? 'active' : ''"
	            onclick="goToSemester(this)">2학년 2학기</button>
			<button class="semester-tab" 
            	data-semester="3-1" 
				th:classappend="${semesterId == '3-1'} ? 'active' : ''"
				onclick="goToSemester(this)">3학년 1학기</button>
			<button class="semester-tab" 
				data-semester="3-2" 
				th:classappend="${semesterId == '3-2'} ? 'active' : ''"
				onclick="goToSemester(this)">3학년 2학기</button>
			<button class="semester-tab"
				data-semester="4-1"
				th:classappend="${semesterId == '4-1'} ? 'active' : ''"
				onclick="goToSemester(this)">4학년 1학기</button>
			<button class="semester-tab"
				data-semester="4-2"
				th:classappend="${semesterId == '4-2'} ? 'active' : ''"
				onclick="goToSemester(this)">4학년 2학기</button>
		</div>

        <div class="gpa-info">
            <div class="gpa-item">
                <label for="totalCredits">전체 학점:</label>
                <span th:text="${gpa.totalCredits}">80</span>
            </div>
            <div class="gpa-item">
                <label for="majorCredits">전공 학점:</label>
                <span th:text="${gpa.majorCredits}">65</span>
            </div>
            <div class="gpa-item">
                <label for="electiveCredits">교양 학점:</label>
                <span th:text="${gpa.electiveCredits}">15</span>
            </div>
            <div class="gpa-item">
                <label for="totalGPA">전체 평점:</label>
                <p><span th:text="${gpa.totalGpa}">3.5</span></p>
				<p><span th:text="${gpa.totalChange}" th:style="${gpa.totalChange >= 0 ? 'color: green;' : 'color: red;'}"></span></p>
            </div>
            <div class="gpa-item">
                <label for="majorGPA">전공 평점:</label>
                <p><span th:text="${gpa.majorGpa}">3.5</span></p>
				<p><span th:text="${gpa.majorChange}" th:style="${gpa.majorChange >= 0 ? 'color: green;' : 'color: red;'}"></span></p>
            </div>
            <div class="gpa-item">
                <label for="electiveGPA">교양 평점:</label>
                <p><span th:text="${gpa.electiveGpa}">3.5</span></p>
				<p><span th:text="${gpa.electiveChange}" th:style="${gpa.electiveChange >= 0 ? 'color: green;' : 'color: red;'}"></span></p>
            </div>
        </div>

        <!-- 학점 통계 (그래프나 표) -->
        <div class="gpa-statistics">
            <h2>등록된 과목</h2>
            <!-- 전체 학기 기준으로 학점과 성적 데이터 출력하고 enrolled_courses 테이블에서 과목명, 학점, 성적, 전공여부만 표로 출력 -->
			<form th:action="@{/gpa/update}" method="post">
			    <table>
			        <thead>
			            <tr>
			                <th>과목명</th>
			                <th>학점</th>
			                <th>성적</th>
			                <th>전공 여부</th>
			                <th>삭제</th>
			            </tr>
			        </thead>
			        <tbody>
			            <tr th:each="course : ${enrolledCourses}">
			                <!-- 과목명 (수정 가능한 입력 필드) -->
			                <td><input type="text" th:value="${course.courseName}" name="courses[${course.id}].courseName" required /></td>
							<input type="hidden" th:value="${course.id}" name="courses[${course.id}].id" />

			                <!-- 학점 (수정 가능한 입력 필드) -->
			                <td><input type="number" th:value="${course.credits}" name="courses[${course.id}].credits" required /></td>

			                <!-- 성적 (수정 가능한 입력 필드) -->
			                <td><input type="text" th:value="${course.grade}" name="courses[${course.id}].grade" required /></td>

			                <!-- 전공 여부 (수정 가능한 체크박스) -->
			                <td><input type="checkbox" th:checked="${course.isMajor}" name="courses[${course.id}].isMajor" /></td>

			                <!-- 삭제 버튼 (각 행마다 개별적으로 삭제) -->
			                <td>
			                    <button type="button" th:data-id="${course.id}" class="delete-button">삭제</button>
			                </td>
			            </tr>
			        </tbody>
			    </table>

			    <!-- 전체 수정 버튼 (한 번에 수정 제출) -->
			    <button type="submit">전체 수정</button>
			</form>
        </div>

        <!-- 학점 입력 폼 -->
        <div class="input-form">
            <h2>학점 입력</h2>
            <form action="/gpa/calculate" method="POST">
				<input type="hidden" name="userId" value="${session.userId}">
		        <input type="hidden" name="semesterId" value="${session.semesterId}">
                <table>
                    <tr>
                        <td><label for="courseName">과목명:</label></td>
                        <td><input type="text" id="courseName" name="courseName" required></td>
                    </tr>
                    <tr>
                        <td><label for="credits">학점:</label></td>
                        <td><input type="number" id="credits" name="credits" required></td>
                    </tr>
                    <tr>
                        <td><label for="grade">성적:</label></td>
                        <td><input type="number" step="0.01" id="grade" name="grade" required></td>
                    </tr>
                    <tr>
                        <td><label for="isMajor">전공 여부:</label></td>
                        <td><input type="checkbox" id="isMajor" name="isMajor"></td>
                    </tr>
                </table>
                <input type="submit" value="학점 추가">
            </form>
        </div>
    </div>
</div>

</body>
</html>
